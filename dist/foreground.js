(()=>{"use strict";var t;function e(t,e){if(null===t)return[0,0];let n=t.parentElement||t,o=0,s=e.anchorOffset||0;do{o+=n.offsetTop||0,s+=n.offsetLeft||0,n=n.offsetParent}while(n);return[o,s]}function n(t){t.stopImmediatePropagation()}function o(t){return`${t}px`}!function(t){t.normal="Normal",t.search="Search"}(t||(t={}));class s extends HTMLElement{constructor(){super(),this.attributeChangedCallback=(t,e,n)=>{console.log(t,e,n)},this.recordPosition=t=>{const[e,n]=[parseInt(this.style.top),parseInt(this.style.left)],{pageX:o,pageY:s}=t;document.body.style.userSelect="none",this.state.adjustment=[e-s,n-o],this.state.dragging=!0,this.container.classList.add("dragging")},this.drag=t=>{if(this.state.dragging){const[e,n]=this.state.adjustment;this.style.top=o(t.pageY+e),this.style.left=o(t.pageX+n)}},this.updatePosition=(t,e)=>{this.style.top=o(t),this.style.left=o(e)},this.attachShadow({mode:"open"}),this.state={dragging:!1,adjustment:[0,0]},this.container=document.createElement("div");const t=document.createElement("h3");t.textContent=this.hasAttribute("header-text")?this.getAttribute("header-text"):"Note";const e=document.createElement("textarea");t.classList.add("header"),e.classList.add("input"),this.container.classList.add("container"),this.container.appendChild(t),this.container.appendChild(e);const s=document.createElement("style");s.textContent=r,this.input=e;const i=document.body.style.userSelect;return this.input.onmousedown=n,this.container.onmousedown=this.recordPosition,document.onmousemove=this.drag,this.container.onmouseup=()=>{document.body.style.userSelect=i,this.state.dragging=!1,this.container.classList.remove("dragging")},this.shadowRoot.append(s,this.container),this}}const r="\n  .header {\n    font-family: sans serif;\n  }\n  .container {\n    opacity: 0.6;\n    position: absolute;\n    width: 200px;\n    height: 200px;\n    background-color: yellow;\n    cursor: pointer;\n    padding: 0.5rem 0.5rem 0 0.5rem;\n  }\n\n  .input {\n    resize: none;\n    width: 100%;\n    height: 70%;\n  }\n\n  .dragging {\n    opacity: 0.2;\n    background-color: purple;\n    transform: translate(20deg);\n  }\n";customElements.define("share-note",s);const i=function(t){return this.name=t,e=>({action:t,data:e})}("ADD_BASIC_NOTE"),c=(a=function(t,{action:e,data:n}){switch(e){case i.name:default:return t}},t=>{browser.storage.local.get(window.location.href).then((e=>a(e,t))).then((t=>browser.storage.local.set({[window.location.href]:t})))});var a;const d=document.createElement("style");d.textContent="\n  share-note {\n    position: absolute;\n    width: 200px;\n    height: 200px;\n    backgroundColor: red;\n  }\n",document.body.append(d),function(t){t.body.style.border="3px solid green"}(document);const h=["TEXTAREA","INPUT"],u={normal:"Backslash",search:"Forwardslash"},l=new class{constructor(t){this._contextEntries=t,this._currentContext="",this._action="",this._object=""}clear(){this._currentContext="",this._action="",this._object=""}triggerContext(e){if(this.inContext)return!1;switch(e){case this._contextEntries.normal:return this._currentContext=t.normal,!0;case this._contextEntries.search:return this._currentContext=t.search,!0;default:return this._currentContext="",!1}}add(t){return this.inContext?""===this._action?this._action=t:""===this._object&&(this._object=t):this.triggerContext(t),this}get sequenceComplete(){return!!this._action&&!!this._object}get inContext(){return""!==this._currentContext}get sequence(){return[this._action,this._object].join("-")}get contextEntries(){return this._contextEntries}set contextEntries(t){this._contextEntries=t}get currentContext(){return this._currentContext}}(u);document.addEventListener("keydown",(n=>{return h.includes(document.activeElement.nodeName)?null:l.add(n.code).sequenceComplete?"Escape"===n.code?(l.clear(),null):(l.add(n.code),void(l.currentContext===t.normal?(t=>{switch(t){case"KeyA-KeyN":console.log("Add Note Path Hit");const n=function(t){const n=t.anchorNode;let o;o=n instanceof HTMLElement?function(t){const n=e(t,{anchorOffset:0}),o=document.createElement("share-note");return o.updatePosition(...n),document.body.appendChild(o),n}(n):function(t,n){const o=e(t,{anchorOffset:n.anchorOffset}),s=document.createElement("share-note");return s.updatePosition(...o),document.body.appendChild(s),s.input.focus(),o}(n,t),browser.storage.local.get("ids").then((t=>{const{ids:e}=t,n=e[e.length-1]+1;return[...e,n]})).then((t=>{browser.storage.local.set({ids:t})}))}(document.getSelection());c(i(n));break;case"KeyA-KeyA":console.log("Add Question Note Path Hit");break;case"KeyN-KeyV":console.log("Make the notes invisible!");break;default:console.log(`Not a configured normal mode action sequence ${t}`)}})(l.sequence):l.currentContext===t.search&&(o=l.sequence,console.log(`Not a configured search mode action sequence ${o}`)))):null;var o})),document.addEventListener("keyup",(t=>{l.sequenceComplete&&l.clear()})),document.addEventListener("selectionchange",(t=>{""===document.getSelection().toString()&&l.clear(),l.inContext||l.triggerContext(u.normal)}))})();