(()=>{"use strict";var t,e=new Uint8Array(16);function n(){if(!t&&!(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(e)}const o=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,s=function(t){return"string"==typeof t&&o.test(t)};for(var i=[],r=0;r<256;++r)i.push((r+256).toString(16).substr(1));const a=function(t,e,o){var r=(t=t||{}).random||(t.rng||n)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,e){o=o||0;for(var a=0;a<16;++a)e[o+a]=r[a];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(i[t[e+0]]+i[t[e+1]]+i[t[e+2]]+i[t[e+3]]+"-"+i[t[e+4]]+i[t[e+5]]+"-"+i[t[e+6]]+i[t[e+7]]+"-"+i[t[e+8]]+i[t[e+9]]+"-"+i[t[e+10]]+i[t[e+11]]+i[t[e+12]]+i[t[e+13]]+i[t[e+14]]+i[t[e+15]]).toLowerCase();if(!s(n))throw TypeError("Stringified UUID is invalid");return n}(r)};var c;function d(){return`${window.location.origin}${window.location.pathname}`}function l(t){return`${t}px`}function u(t){return parseInt(t)}!function(t){t.normal="Normal",t.search="Search"}(c||(c={}));const h=t=>{t.stopImmediatePropagation()},g=[".container",".input",".header",".deleteBtn"];class p extends HTMLElement{constructor(){super(),this.updatePosition=(t,e)=>{this.style.top=l(t),this.style.left=l(e)},this.setValue=t=>{this.state.children.input.value=t},this.stopDragging=()=>{var t;this.state.dragging=!1,null===(t=this.state.children)||void 0===t||t.container.classList.remove("dragging"),document.body.style.userSelect=this.state.userSelect,this.dispatch("ondragstop",[u(this.style.top),u(this.style.left)]),document.onmousemove=null},this.startDragging=()=>{var t;null===(t=this.state.children)||void 0===t||t.container.classList.add("dragging"),document.body.style.userSelect="none",this.state.dragging=!0,document.onmousemove=this.drag},this.capturePosition=t=>{const[e,n]=[u(this.style.top),u(this.style.left)],{pageX:o,pageY:s}=t;this.state.adjustment=[e-s,n-o]},this.isOpaque=t=>{t?this.state.children.container.classList.add("opaque"):this.state.children.container.classList.remove("opaque")},this.dispatch=(t,e)=>{this.dispatchEvent(new CustomEvent(t,{detail:e}))},this.drag=t=>{if(this.state.dragging){const[e,n]=this.state.adjustment;this.style.top=l(t.pageY+e),this.style.left=l(t.pageX+n)}},this.attachShadow({mode:"open"}),this.state={dragging:!1,adjustment:[0,0],children:{},userSelect:""};const t=document.getElementById("share-note-note-template").content.cloneNode(!0);return this.state.children=((t,e)=>{const n=(o=t,t=>o.querySelector(t));var o;return e.reduce(((t,e)=>{return Object.assign(t,{[(o=e,o.replace(".",""))]:n(e)});var o}),{})})(t,g),this.state.children.deleteBtn.onclick=()=>{this.dispatch("softdelete",parseInt(this.id))},this.state.children.header.onmousedown=t=>{this.capturePosition(t),this.startDragging()},this.state.children.header.onmouseup=this.stopDragging,this.state.children.input.onmousedown=h,this.state.children.input.onfocus=()=>this.isOpaque(!1),this.state.children.input.onblur=()=>this.isOpaque(!0),this.state.children.input.onchange=()=>{this.dispatch("noteupdate",this.state.children.input.value)},this.state.userSelect=document.body.style.userSelect,this.shadowRoot.append(t),this}set content(t){this._content=t}get content(){return this._content}}function m(t){function e(e){return{type:t,data:e}}return e.type=t,e}const f={notesVisible:!0,deletedIds:[],activeIds:[],notes:{}},y="notes-container";function v(){const t=new Date;return`${t.toLocaleDateString()} at ${t.toLocaleTimeString()}`}let b=[],E=-1;const w=m("ADD_BASIC_NOTE"),C=m("DRAG_STOP_POSITION_CHANGE"),I=m("NOTE_CONTENT_UPDATE"),_=m("SOFT_DELETE_NOTE"),x=m("TOGGLE_VISIBILITY"),O=(j=function(t,{type:e,data:n}){void 0===t&&(t=f),console.log(t,n);const{notesVisible:o,deletedIds:s,activeIds:i,notes:r}=t,c=r[n.id];let d;switch(console.log("switching"),e){case w.type:const e=a();return o||M(t),b.push(e),{notesVisible:!0,activeIds:[...i,e],deletedIds:[...s],notes:Object.assign(Object.assign({},r),{[e]:(l=e,u=n.position,{id:l,position:u,content:"",isDeleted:!1,createdAt:v(),updatedAt:v()})})};case C.type:return d=Object.assign(Object.assign({},c),{position:n.position}),{notesVisible:o,activeIds:[...i],deletedIds:[...s],notes:Object.assign(Object.assign({},r),{[c.id]:d})};case I.type:return d=Object.assign(Object.assign({},c),{content:n.content}),{notesVisible:o,activeIds:[...i],deletedIds:[...s],notes:Object.assign(Object.assign({},r),{[c.id]:d})};case _.type:d=Object.assign(Object.assign({},c),{isDeleted:!0});const h=document.getElementById(c.id);return document.body.removeChild(h),{notesVisible:o,activeIds:i.filter((t=>t===c.id)),deletedIds:[...s,c.id],notes:Object.assign(Object.assign({},r),{[c.id]:d})};case x.type:return n?M(t):document.querySelectorAll("share-note").forEach((t=>{document.body.removeChild(t)})),{notesVisible:n,activeIds:[...i],deletedIds:[...s],notes:Object.assign({},r)};default:return t}var l,u},t=>{return e=void 0,n=void 0,s=function*(){const e=d();return browser.storage.local.get(e).then((n=>(console.log("calling the reducer"),j(n[e],t)))).then((t=>(browser.storage.local.set({[e]:t}),t)))},new((o=void 0)||(o=Promise))((function(t,i){function r(t){try{c(s.next(t))}catch(t){i(t)}}function a(t){try{c(s.throw(t))}catch(t){i(t)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(r,a)}c((s=s.apply(e,n||[])).next())}));var e,n,o,s});var j;const N=document.createElement("style");N.textContent="\n  share-note {\n    position: absolute;\n    width: 200px;\n    height: 200px;\n    backgroundColor: red;\n  }\n",document.body.append(N);const L=["TEXTAREA","INPUT"],S={normal:"Backslash",search:"Forwardslash"},T=new class{constructor(t){this._contextEntries=t,this._currentContext="",this._action="",this._object=""}clear(){this._currentContext="",this._action="",this._object=""}triggerContext(t){if(this.inContext)return!1;switch(t){case this._contextEntries.normal:return this._currentContext=c.normal,!0;case this._contextEntries.search:return this._currentContext=c.search,!0;default:return this._currentContext="",!1}}add(t){return this.inContext?""===this._action?this._action=t:""===this._object&&(this._object=t):this.triggerContext(t),this}get sequenceComplete(){return!!this._action&&!!this._object}get inContext(){return""!==this._currentContext}get sequence(){return[this._action,this._object].join("-")}get contextEntries(){return this._contextEntries}set contextEntries(t){this._contextEntries=t}get currentContext(){return this._currentContext}}(S),V=t=>e=>{O(C({id:t.id,position:e.detail}))};function q(t,e){const n=X(y),o=document.createElement("share-note");return o.updatePosition(...t),o.addEventListener("noteupdate",(t=>{const e=t.detail;O(I({id:o.id,content:e}))})),o.content=e||"",o.setValue(o.content),n.appendChild(o),o}let A={hotkeys:{clear:"Escape",addNote:"KeyA-KeyN",addQuestion:"KeyA-KeyA",toggleVisible:"KeyN-KeyV",nextNote:"KeyN-KeyN"}};browser.storage.local.get("note-share-settings").then((t=>{void 0!==t&&(A=t)}));const{hotkeys:D}=A,k=D.clear,P=D.addNote,B=D.addQuestion,$=D.toggleVisible,K=D.nextNote,R=t=>{return L.includes(document.activeElement.nodeName)?null:T.add(t.code).sequenceComplete?"Escape"===t.code?(T.clear(),null):(T.add(t.code),void(T.currentContext===c.normal?(t=>{switch(t){case P:const e=document.getSelection();let n=0;e.anchorNode instanceof HTMLElement||(n=e.anchorOffset);const o=function(t,e){if(null===t)return[0,0];let n=t.parentElement||t,o=0,s=e.anchorOffset||0;do{o+=n.offsetTop||0,s+=n.offsetLeft||0,n=n.offsetParent}while(n);return[o,s]}(e.anchorNode,{anchorOffset:n});console.log("adding a note at position",o);const s=q(o,void 0);setTimeout((()=>s.input.focus()),20),O(w({position:o})).then((t=>{var e;s.id=(e=t.noteIds)[e.length-1],s.addEventListener("ondragstop",V(s))}));break;case B:console.log("Add Question Note Path Hit");break;case $:console.log("trying to toggle visibility"),G().then((t=>{O(x(!t.notesVisible))}));break;case K:let i=0;E+1>=b.length||(i=E+1),function(t){window.scrollTo({top:parseInt(t.style.top),left:parseInt(t.style.left),behavior:"smooth"})}(document.getElementById(`${b[i]}`)),E=i;break;case k:console.log("clearing the stack"),T.clear();break;default:console.log(`Not a configured normal mode action sequence ${t}`)}})(T.sequence):T.currentContext===c.search&&(e=T.sequence,console.log(`Not a configured search mode action sequence ${e}`)))):null;var e},H=()=>{T.sequenceComplete&&T.clear()},U=t=>{""===document.getSelection().toString()&&T.clear(),T.inContext||T.triggerContext(S.normal)};function G(){return t=this,e=void 0,o=function*(){const t=d();return browser.storage.local.get(t).then((e=>e[t]))},new((n=void 0)||(n=Promise))((function(s,i){function r(t){try{c(o.next(t))}catch(t){i(t)}}function a(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}c((o=o.apply(t,e||[])).next())}));var t,e,n,o}function M(t){const{activeIds:e,notes:n}=t;return e.forEach((t=>{const{position:e,content:o}=n[t],s=q(e,o);s.id=`${t}`,s.addEventListener("ondragstop",V(s)),s.addEventListener("softdelete",(t=>e=>{console.log("calling the soft delete handler."),O(_({id:t.id}))})(s)),s.addEventListener("noteupdate",(t=>console.log("noteupdate event",t)))})),t}function Q(t){const{activeIds:e}=t;return b=e,E=0,t}const X=t=>{const e=document.getElementById(t);if(e)return e;const n=document.createElement("div");return n.id=t,n};browser.runtime.onMessage.addListener((t=>{const e=t.map((t=>t[1])),n=t.map((t=>t[0])),o=X("templates-container"),s=X(y);document.body.appendChild(o),document.body.appendChild(s),o.innerHTML=e.join(""),n.forEach((t=>console.log(document.getElementById(t)))),customElements.define("share-note",p),document.addEventListener("keydown",R),document.addEventListener("keyup",H),document.addEventListener("selectionchange",U),G().then(Q).then(M).then((()=>console.log("initialization complete")))}))})();