(()=>{"use strict";var t,e=new Uint8Array(16);function n(){if(!t&&!(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(e)}const o=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,s=function(t){return"string"==typeof t&&o.test(t)};for(var i=[],r=0;r<256;++r)i.push((r+256).toString(16).substr(1));const a=function(t,e,o){var r=(t=t||{}).random||(t.rng||n)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,e){o=o||0;for(var a=0;a<16;++a)e[o+a]=r[a];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(i[t[e+0]]+i[t[e+1]]+i[t[e+2]]+i[t[e+3]]+"-"+i[t[e+4]]+i[t[e+5]]+"-"+i[t[e+6]]+i[t[e+7]]+"-"+i[t[e+8]]+i[t[e+9]]+"-"+i[t[e+10]]+i[t[e+11]]+i[t[e+12]]+i[t[e+13]]+i[t[e+14]]+i[t[e+15]]).toLowerCase();if(!s(n))throw TypeError("Stringified UUID is invalid");return n}(r)};var c;function d(t){t.stopImmediatePropagation()}function l(t){return`${t}px`}!function(t){t.normal="Normal",t.search="Search"}(c||(c={}));class h extends HTMLElement{constructor(){super(),this.recordPosition=t=>{const[e,n]=[parseInt(this.style.top),parseInt(this.style.left)],{pageX:o,pageY:s}=t;document.body.style.userSelect="none",this.state.adjustment=[e-s,n-o],this.state.dragging=!0,this.container.classList.add("dragging"),document.onmousemove=this.drag},this.drag=t=>{if(this.state.dragging){const[e,n]=this.state.adjustment;this.style.top=l(t.pageY+e),this.style.left=l(t.pageX+n)}},this.updatePosition=(t,e)=>{this.style.top=l(t),this.style.left=l(e)},this.attachShadow({mode:"open"}),this.state={dragging:!1,adjustment:[0,0]},this.container=document.createElement("div");const t=document.createElement("h3");t.textContent=this.hasAttribute("header-text")?this.getAttribute("header-text"):"Note",this.input=document.createElement("textarea"),this.delete=document.createElement("button"),this.delete.textContent="Delete",t.classList.add("header"),this.input.classList.add("input"),this.container.classList.add("container"),this.delete.classList.add("delete"),this.container.appendChild(t),this.container.appendChild(this.input),this.container.appendChild(this.delete);const e=document.createElement("style");e.textContent=u;const n=document.body.style.userSelect;return this.input.onmousedown=d,this.delete.onclick=t=>{const e=new CustomEvent("softdelete",{detail:parseInt(this.id)});this.dispatchEvent(e)},this.container.onmousedown=this.recordPosition,this.container.onmouseup=()=>{document.body.style.userSelect=n,this.state.dragging=!1,this.container.classList.remove("dragging"),console.log("should emit");const t=new CustomEvent("ondragstop",{detail:[parseInt(this.style.top),parseInt(this.style.left)]});this.dispatchEvent(t),console.log("should have emitted"),document.onmousemove=null},this.shadowRoot.append(e,this.container),this}hide(){this.classList.add("hidden")}show(){this.classList.remove("hidden")}}const u="\n  .hidden { \n    visibility: none; \n    display: none; \n  }\n\n  .header {\n    font-family: sans serif;\n    width: 100%;\n  }\n  .container {\n    z-index: 10000000;\n    opacity: 0.6;\n    position: absolute;\n    width: 200px;\n    height: 200px;\n    background-color: yellow;\n    cursor: pointer;\n    padding: 0.5rem 0.5rem 0 0.5rem;\n  }\n\n  .input {\n    resize: none;\n    width: 100%;\n    height: 70%;\n  }\n\n  .dragging {\n    opacity: 0.2;\n    background-color: purple;\n    transform: translate(20deg);\n  }\n\n  .delete {\n    background-color: red;\n  }\n";class g extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.container=document.createElement("span"),this.container.classList.add("highlighted");let t="yellow";return this.hasAttribute("color")&&(t=this.getAttribute("color")),document.createElement("style").textContent=`\n      .highlighted {background-color: ${t};}\n      .hidden { visibility: none; display: none; }\n    `,this.shadowRoot.append(this.container),this}hide(){this.classList.add("hidden")}show(){this.classList.remove("hidden")}}function p(t){function e(e){return{type:t,data:e}}return e.type=t,e}const m={deletedIds:[],activeIds:[],notes:{}};let f=[],y=-1;const v=p("ADD_BASIC_NOTE"),b=p("DRAG_STOP_POSITION_CHANGE"),w=p("NOTE_CONTENT_UPDATE"),x=(E=function(t,{type:e,data:n}){void 0===t&&(t=m);const{deletedIds:o,activeIds:s,notes:i}=t,r=i[n.id];let c;switch(e){case v.type:const e=a();return{activeIds:[...s,e],deletedIds:[...o],notes:Object.assign(Object.assign({},i),{[e]:(d=e,l=n.position,{id:d,position:l,content:"",isDeleted:!1})})};case b.type:return c=Object.assign(Object.assign({},r),{position:n.position}),{activeIds:[...s],deletedIds:[...o],notes:Object.assign(Object.assign({},i),{[r.id]:c})};case w.type:return c=Object.assign(Object.assign({},r),{content:n.content}),{activeIds:[...s],deletedIds:[...o],notes:Object.assign(Object.assign({},i),{[r.id]:c})};default:return t}var d,l},t=>{return e=void 0,n=void 0,s=function*(){const e=window.location.href;return browser.storage.local.get(e).then((n=>(console.log("calling the reducer"),E(n[e],t)))).then((t=>(browser.storage.local.set({[window.location.href]:t}),t)))},new((o=void 0)||(o=Promise))((function(t,i){function r(t){try{c(s.next(t))}catch(t){i(t)}}function a(t){try{c(s.throw(t))}catch(t){i(t)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(r,a)}c((s=s.apply(e,n||[])).next())}));var e,n,o,s});var E;const C=document.createElement("style");C.textContent="\n  share-note {\n    position: absolute;\n    width: 200px;\n    height: 200px;\n    backgroundColor: red;\n  }\n",document.body.append(C);const _=["TEXTAREA","INPUT"],I={normal:"Backslash",search:"Forwardslash"},N=new class{constructor(t){this._contextEntries=t,this._currentContext="",this._action="",this._object=""}clear(){this._currentContext="",this._action="",this._object=""}triggerContext(t){if(this.inContext)return!1;switch(t){case this._contextEntries.normal:return this._currentContext=c.normal,!0;case this._contextEntries.search:return this._currentContext=c.search,!0;default:return this._currentContext="",!1}}add(t){return this.inContext?""===this._action?this._action=t:""===this._object&&(this._object=t):this.triggerContext(t),this}get sequenceComplete(){return!!this._action&&!!this._object}get inContext(){return""!==this._currentContext}get sequence(){return[this._action,this._object].join("-")}get contextEntries(){return this._contextEntries}set contextEntries(t){this._contextEntries=t}get currentContext(){return this._currentContext}}(I),L=t=>e=>{x(b({id:t.id,position:e.detail}))};function j(t,e){const n=document.createElement("share-note");return n.updatePosition(...t),n.input.addEventListener("change",(t=>{const e=t.currentTarget.value;x(w({id:n.id,content:e}))})),n.input.value=e||"",document.body.appendChild(n),n}let O={hotkeys:{clear:"KeyEscape",addNote:"KeyA-KeyN",addQuestion:"KeyA-KeyA",toggleVisible:"KeyN-KeyV",nextNote:"KeyN-KeyN"}};browser.storage.local.get("note-share-settings").then((t=>{void 0!==t&&(O=t)}));const{hotkeys:k}=O,T=k.clear,A=k.addNote,S=k.addQuestion,P=k.toggleVisible,K=k.nextNote;customElements.define("share-note",h),customElements.define("share-highlight",g),document.addEventListener("keydown",(t=>{return _.includes(document.activeElement.nodeName)?null:N.add(t.code).sequenceComplete?"Escape"===t.code?(N.clear(),null):(N.add(t.code),void(N.currentContext===c.normal?(t=>{switch(t){case A:const e=document.getSelection();let n=0;e.anchorNode instanceof HTMLElement||(n=e.anchorOffset);const o=function(t,e){if(null===t)return[0,0];let n=t.parentElement||t,o=0,s=e.anchorOffset||0;do{o+=n.offsetTop||0,s+=n.offsetLeft||0,n=n.offsetParent}while(n);return[o,s]}(e.anchorNode,{anchorOffset:n});console.log("adding a note at position",o);const s=j(o,void 0);setTimeout((()=>s.input.focus()),20),x(v({position:o})).then((t=>{var e;s.id=(e=t.noteIds)[e.length-1],s.addEventListener("ondragstop",L(s))}));break;case S:console.log("Add Question Note Path Hit");break;case P:console.log("Make the notes invisible!");break;case K:let i=0;y+1>=f.length||(i=y+1),function(t){window.scrollTo({top:parseInt(t.style.top),left:parseInt(t.style.left),behavior:"smooth"})}(document.getElementById(`${f[i]}`)),y=i;break;case T:console.log("clearing the stack"),N.clear();break;default:console.log(`Not a configured normal mode action sequence ${t}`)}})(N.sequence):N.currentContext===c.search&&(e=N.sequence,console.log(`Not a configured search mode action sequence ${e}`)))):null;var e})),document.addEventListener("keyup",(()=>{N.sequenceComplete&&N.clear()})),document.addEventListener("selectionchange",(t=>{""===document.getSelection().toString()&&N.clear(),N.inContext||N.triggerContext(I.normal)})),function(){return t=this,e=void 0,o=function*(){const t=window.location.href;return browser.storage.local.get(t).then((e=>e[t]))},new((n=void 0)||(n=Promise))((function(s,i){function r(t){try{c(o.next(t))}catch(t){i(t)}}function a(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}c((o=o.apply(t,e||[])).next())}));var t,e,n,o}().then((function(t){const{activeIds:e}=t;return f=e,y=0,t})).then((function(t){const{activeIds:e,notes:n}=t;return e.forEach((t=>{const{position:e,content:o}=n[t],s=j(e,o);s.id=`${t}`,s.addEventListener("ondragstop",L(s))})),t})).then((()=>console.log("initialization complete")))})();